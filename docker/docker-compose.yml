# NOTE: Do not use chmod 777 or 666.
# Use proper ownership (chown) and safe permissions instead (chmod 755).

# Common environment variables
x-common-environment: &common-environment
  PYTHONPATH: /app/src

# Build-only service to produce the base runtime image used by derived images.
# This service is profile-hidden so it does not run by default; run
# `docker compose build tram-base` to build the base image locally.
services:
  tram-base:
    build:
      context: ..
      dockerfile: docker/Dockerfile.base
    image: tram-base:latest
    profiles:
      - build-base
      
  # GTFS Static data ingestion (short-lived task)
  gtfs-ingest-static:
    image: tram-ingest:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.ingest
      args:
        BASE_IMAGE: tram-base:latest
        APP_UID: 1000
        APP_GID: 1000
    volumes:
      - ../data:/app/data:z
      - ../logs:/app/logs:z
      - ../configs:/app/configs:z
      - ../src:/app/src:z
      - ../scripts:/app/scripts:z
    environment: *common-environment
    # Single execution per container instance (Static data only)
    command: ["--feed-type", "gtfs_static", "--once"]
    restart: "no"  # Short-lived task
    profiles:
      - ingest  # Run manually or via scheduler

  # GTFS-RT realtime data ingestion (short-lived task)
  gtfs-ingest-realtime:
    image: tram-ingest-realtime:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.ingest-realtime
      args:
        BASE_IMAGE: tram-base:latest
        APP_UID: 1000
        APP_GID: 1000
    volumes:
      - ../data:/app/data:z
      - ../logs:/app/logs:z
      - ../configs:/app/configs:z
    environment: *common-environment
    # Single execution per container instance (RT data only)
    command: ["--feed-type", "realtime", "--once"]
    restart: "no"  # Short-lived task
    profiles:
      - ingest  # Run manually or via scheduler

  # SUMO installation service for building the image
  SUMO-tutorial:
    image: ghcr.io/eclipse-sumo/sumo:latest
    volumes:
      - ../src/sim_bridge/sumo-projs/sumotutorial:/data           # Mounts local simulation data folder into container
      - /tmp/.X11-unix:/tmp/.X11-unix   # X11 socket for GUI display forwarding
    environment:
      - DISPLAY=${DISPLAY}              # Passes host DISPLAY environment variable for X11
      - QT_X11_NO_MITSHM=1              # Prevents shared memory errors for Qt X11
      - XAUTHORITY=${XAUTHORITY}        # Passes X11 authentication file path
    command: sumo-gui /data/hello.sumocfg   # Starts SUMO GUI with simulation config
    working_dir: /data
    stdin_open: true                    # Keeps STDIN open even if not attached (equivalent to -i)
    tty: true                           # Allocates a pseudo-TTY (equivalent to -t)

  # Simulation execution
  simulation:
    image: tram-sim:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.sim
      args:
        BASE_IMAGE: tram-base:latest
    volumes:
      - ../data:/app/data:z
      - ../results:/app/results:z
      - ../logs:/app/logs:z
    environment:
      - PYTHONPATH=/app/src
      - SUMO_HOME=/opt/sumo
    command: ["--config", "configs/sim/toyama_tram.yaml"]
    restart: "no"

  # Training execution
  training:
    image: tram-train:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.train
      args:
        BASE_IMAGE: tram-base:latest
    volumes:
      - ../data:/app/data:z
      - ../models:/app/models:z
      - ../results:/app/results:z
      - ../logs:/app/logs:z
    environment:
      - PYTHONPATH=/app/src
    command: ["--config", "configs/train/qddqn.yaml", "--episodes", "1000"]
    restart: "no"
    # Uncomment the following for GPU support
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # Development service: mounts project root and starts an interactive
  # environment (JupyterLab). Port is bound only to localhost for safety.
  dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
      args:
        APP_UID: 1000
        APP_GID: 1000
    image: tram-dev:latest
    volumes:
      - ..:/app:z
    environment: *common-environment
    ports:
      - "127.0.0.1:8888:8888"
    profiles:
      - dev

# Volume definitions
volumes:
  data:
  models:
  results:
  logs:
